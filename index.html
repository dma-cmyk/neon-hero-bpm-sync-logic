<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éç„Ç™„É≥„Éª„Éí„Éº„É≠„Éº - „Éó„É™„Ç∫„É†„Éª„Ç®„Éá„Ç£„Ç∑„Éß„É≥</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');

        :root {
            /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ: „Éá„Ç£„Éº„Éó„Éª„Çπ„Éö„Éº„Çπ„Éª„Éç„Ç™„É≥ */
            --bg-color: #03030b;
            --container-bg: radial-gradient(circle at top, #101030 0%, #03030b 100%);
            --overlay-bg: rgba(5, 5, 20, 0.85);
            --text-color: #ffffff;
            --input-bg: rgba(255, 255, 255, 0.05);
            --panel-bg: rgba(255, 255, 255, 0.03);
            --panel-border: rgba(0, 242, 255, 0.3);
            
            --neon-cyan: #00f2ff;
            --neon-pink: #ff007a;
            --neon-lime: #bcff00;
            --neon-purple: #9d00ff;
            --grid-color: rgba(0, 242, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.8);
            --shine-gradient: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            --scroll-thumb: linear-gradient(to bottom, var(--neon-cyan), var(--neon-purple));
        }

        /* „É©„Ç§„Éà„É¢„Éº„Éâ: „Ç™„Éë„Éº„É´„Éª„Éó„É™„Ç∫„É† */
        body.light-mode {
            --bg-color: #f0f4f8;
            --container-bg: linear-gradient(135deg, #eef2ff 0%, #fdeff9 50%, #e0f2fe 100%);
            --overlay-bg: rgba(255, 255, 255, 0.75);
            --text-color: #2d3748;
            --input-bg: rgba(255, 255, 255, 0.9);
            --panel-bg: rgba(255, 255, 255, 0.5);
            --panel-border: rgba(66, 153, 225, 0.3);
            
            --neon-cyan: #0ea5e9;
            --neon-pink: #ec4899;
            --neon-lime: #65a30d;
            --neon-purple: #9333ea;
            --grid-color: rgba(66, 153, 225, 0.1);
            --shadow-color: rgba(100, 116, 139, 0.2);
            --shine-gradient: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            --scroll-thumb: linear-gradient(to bottom, #7dd3fc, #f9a8d4, #c084fc);
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Éá„Ç∂„Ç§„É≥ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
            box-shadow: 0 0 12px var(--neon-cyan);
            transition: 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover { box-shadow: 0 0 20px var(--neon-pink); background: var(--neon-pink); }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Exo 2', 'Noto Sans JP', sans-serif;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; touch-action: none; transition: all 0.5s ease;
        }

        #game-container {
            position: relative; width: 100%; max-width: 500px; height: 100%; max-height: 850px;
            background: var(--container-bg);
            box-shadow: 0 30px 60px var(--shadow-color);
            overflow: hidden; display: flex; flex-direction: column; border-radius: 20px;
            transition: transform 0.1s; /* ÁîªÈù¢Êè∫„ÇåÁî® */
        }

        .grid-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px; z-index: 1;
        }

        .grid-bg-inner {
            width: 100%; height: 200%; background-image: inherit; background-size: inherit;
            transform: rotateX(60deg) translateY(-25%);
            animation: grid-scroll 15s linear infinite;
        }

        @keyframes grid-scroll { from { background-position: 0 0; } to { background-position: 0 500px; } }

        #media-bg-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: auto; opacity: 0; transition: opacity 0.8s ease; overflow: hidden;
        }

        #game-container.is-playing #media-bg-container { opacity: 0.6; }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; background: transparent; pointer-events: none; }

        #theme-toggle {
            position: absolute; top: 15px; right: 15px; z-index: 150;
            background: var(--panel-bg); border: 1.5px solid var(--neon-cyan); color: var(--text-color);
            border-radius: 14px; cursor: pointer; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); box-shadow: 0 8px 15px var(--shadow-color);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 22px;
        }
        #theme-toggle:hover { transform: rotate(15deg) scale(1.1); box-shadow: 0 0 20px var(--neon-cyan); }

        #skip-intro-btn {
            position: absolute; top: 70px; right: 15px; z-index: 150;
            background: var(--panel-bg); border: 1.5px solid var(--neon-lime); color: var(--text-color);
            padding: 8px 15px; border-radius: 12px; cursor: pointer;
            backdrop-filter: blur(10px); box-shadow: 0 4px 12px var(--shadow-color);
            font-size: 11px; font-weight: 900; letter-spacing: 1px; display: none; transition: all 0.2s ease;
        }
        #skip-intro-btn:hover { background: var(--neon-lime); color: #000; box-shadow: 0 0 15px var(--neon-lime); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; z-index: 10; }

        .score-display { margin-top: 40px; font-size: 32px; font-weight: 900; color: var(--neon-cyan); text-shadow: 0 0 15px var(--neon-cyan); letter-spacing: 2px; }

        .combo-display { position: absolute; top: 32%; font-size: 72px; font-weight: 900; color: var(--neon-pink); text-shadow: 0 0 30px var(--neon-pink); opacity: 0; }

        .judgment-display { position: absolute; top: 50%; font-size: 44px; font-weight: 900; text-transform: uppercase; font-style: italic; letter-spacing: 4px; }

        /* Visualizer Display */
        #visualizer-canvas { position: absolute; bottom: 0; left: 0; width: 100%; height: 300px; z-index: 3; pointer-events: none; opacity: 0.6; mix-blend-mode: screen; }

        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); backdrop-filter: blur(25px); z-index: 100; display: flex; flex-direction: column; align-items: center; padding: 30px; box-sizing: border-box; overflow-y: auto; animation: fadeIn 0.6s ease-out; }

        .btn {
            position: relative; padding: 16px 30px; font-size: 18px; font-weight: 900; background: linear-gradient(45deg, var(--neon-pink), var(--neon-purple)); color: white; border: none; border-radius: 18px; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 100%; max-width: 340px; flex-shrink: 0; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 25px var(--shadow-color); overflow: hidden; letter-spacing: 2px;
        }
        .btn::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: var(--shine-gradient); transform: rotate(30deg); transition: 0.5s; opacity: 0; }
        .btn:hover::after { left: 100%; opacity: 1; }
        .btn:hover:not(:disabled) { transform: translateY(-4px); box-shadow: 0 15px 35px var(--shadow-color); }
        .btn:disabled { background: #64748b; cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none; }
        
        /* Experimental Button Style */
        .btn.hybrid { background: linear-gradient(45deg, #0ea5e9, #2563eb); font-size: 12px; margin-top: 5px; padding: 12px; }
        .btn.hybrid.active { background: linear-gradient(45deg, #22c55e, #16a34a); box-shadow: 0 0 15px #22c55e; }

        .input-group { width: 100%; max-width: 420px; background: var(--panel-bg); padding: 22px; border-radius: 24px; border: 1px solid var(--panel-border); margin-bottom: 20px; box-sizing: border-box; box-shadow: 0 10px 30px var(--shadow-color); flex-shrink: 0; }

        .input-label { font-size: 12px; color: var(--text-color); opacity: 0.9; margin-bottom: 10px; display: block; text-align: left; letter-spacing: 1.5px; font-weight: 900; text-transform: uppercase; }

        input[type="text"], input[type="number"] { width: 100%; padding: 14px; border-radius: 14px; border: 1.5px solid rgba(128,128,128,0.2); background: var(--input-bg); color: var(--text-color); box-sizing: border-box; text-align: center; font-size: 15px; outline: none; transition: all 0.3s; font-weight: 700; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); }

        .diff-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; width: 100%; }

        .diff-btn {
            position: relative; padding: 16px; font-size: 14px; font-weight: 900; border-radius: 16px; border: 1.5px solid rgba(128,128,128,0.1); background: var(--input-bg); cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; letter-spacing: 2px; --diff-color: #94a3b8; overflow: hidden;
        }
        .diff-btn::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--diff-color); }
        .diff-btn[data-diff="easy"] { --diff-color: var(--neon-lime); color: var(--neon-lime); }
        .diff-btn[data-diff="normal"] { --diff-color: var(--neon-cyan); color: var(--neon-cyan); }
        .diff-btn[data-diff="hard"] { --diff-color: var(--neon-pink); color: var(--neon-pink); }
        .diff-btn[data-diff="expert"] { --diff-color: var(--neon-purple); color: var(--neon-purple); }
        .diff-btn:hover { background: var(--panel-bg); transform: translateY(-3px); }
        .diff-btn.active { background: var(--diff-color); color: #ffffff !important; box-shadow: 0 10px 30px var(--diff-color); transform: scale(1.08); border-color: transparent; }

        #preview-box { width: 100%; max-width: 420px; aspect-ratio: 16 / 9; background: #000; border-radius: 22px; border: 4px solid var(--neon-cyan); margin-bottom: 30px; overflow: hidden; position: relative; box-shadow: 0 15px 40px var(--shadow-color); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #preview-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 14px; text-align: center; font-weight: 800; }
        
        #preview-content { width: 100%; height: 100%; position: relative; overflow: hidden; pointer-events: auto; }
        #preview-content iframe { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; border: none; }

        .ranking-container { width: 100%; max-width: 420px; background: var(--panel-bg); border-radius: 24px; padding: 25px; margin-bottom: 30px; border: 1.5px solid var(--panel-border); box-sizing: border-box; box-shadow: 0 10px 30px var(--shadow-color); flex-shrink: 0; }
        .ranking-item { display: flex; flex-direction: column; padding: 14px 0; border-bottom: 1px solid rgba(128,128,128,0.15); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-header { display: flex; align-items: center; gap: 15px; }
        .ranking-rank { color: var(--neon-lime); font-weight: 900; width: 35px; font-size: 20px; }
        .ranking-name { flex-grow: 1; color: var(--text-color); font-size: 16px; font-weight: 900; display: flex; align-items: center; gap: 8px; overflow: hidden; }
        .ranking-trip { color: var(--neon-pink); font-size: 12px; font-family: monospace; opacity: 0.8; }
        .ranking-score { color: var(--neon-cyan); font-family: 'Exo 2', sans-serif; font-size: 20px; font-weight: 900; }
        .ranking-comment { margin-top: 8px; padding-left: 50px; color: var(--text-color); opacity: 0.7; font-size: 13px; font-style: italic; line-height: 1.5; word-break: break-all; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); backdrop-filter: blur(40px); z-index: 200; display: none; flex-direction: column; align-items: center; padding: 50px 25px; box-sizing: border-box; }
        .modal.is-visible { display: flex; animation: fadeIn 0.4s ease; }

        .shared-item-full { background: var(--input-bg); border: 1px solid var(--panel-border); padding: 12px; border-radius: 18px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px var(--shadow-color); display: flex; gap: 15px; align-items: center; position: relative; }
        .shared-item-full:hover { background: var(--panel-bg); border-color: var(--neon-cyan); transform: scale(1.03); box-shadow: 0 8px 25px var(--shadow-color); }

        .thumbnail-container { position: relative; width: 120px; height: 68px; flex-shrink: 0; border-radius: 10px; overflow: hidden; background: #000; border: 1.5px solid rgba(128,128,128,0.2); }
        .shared-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .duration-badge { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.85); color: white; padding: 1px 4px; border-radius: 4px; font-size: 10px; font-weight: 900; font-family: monospace; letter-spacing: 0.5px; }

        .shared-item-info { flex-grow: 1; min-width: 0; }
        .shared-item-title { font-size: 15px; font-weight: 800; color: var(--text-color); line-height: 1.4; word-break: break-word; }
        
        .play-count-badge { position: absolute; top: -10px; right: 10px; background: var(--neon-purple); color: white; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 5; }

        .library-tabs { display: flex; gap: 8px; width: 100%; max-width: 450px; margin-bottom: 15px; border-bottom: 1px solid var(--panel-border); padding-bottom: 10px; overflow-x: auto; scrollbar-width: none; flex-shrink: 0; }
        .library-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { background: transparent; border: none; color: var(--text-color); opacity: 0.5; padding: 8px 16px; cursor: pointer; font-weight: 900; font-size: 12px; border-radius: 10px; transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active { opacity: 1; background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

        .key-config-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 15px; }
        .key-bind-btn { background: var(--input-bg); border: 1px solid var(--panel-border); padding: 18px 15px; border-radius: 16px; color: var(--text-color); cursor: pointer; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 15px; transition: 0.3s; }
        .key-bind-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--neon-cyan); }
        .key-bind-btn.waiting { border-color: var(--neon-pink); box-shadow: 0 0 15px var(--neon-pink); animation: pulse 1s infinite; }
        .key-name { font-size: 18px; color: var(--neon-cyan); font-weight: 900; font-family: 'Exo 2', sans-serif; text-transform: uppercase; }
        .lane-arrow { font-size: 28px; font-weight: 900; line-height: 1; filter: drop-shadow(0 0 8px currentColor); }

        /* BPM Control - Improved visibility */
        .bpm-control { display: flex; align-items: center; gap: 10px; width: 100%; }
        #bpm-input { flex: 1; font-size: 18px; background: rgba(0,0,0,0.3); border-color: var(--neon-lime); color: var(--neon-lime); }
        #tap-bpm-btn { flex: 1; background: var(--neon-lime); color: black; border: none; font-size: 14px; font-weight: 900; border-radius: 12px; cursor: pointer; transition: 0.1s; position: relative; overflow: hidden; box-shadow: 0 0 10px var(--neon-lime); }
        #tap-bpm-btn:active { transform: scale(0.95); opacity: 0.8; }
        .bpm-display { font-size: 11px; color: var(--text-color); opacity: 0.8; text-align: center; margin-top: 8px; font-weight: 700; }

        .hidden { display: none !important; }
        .loader { border: 4px solid rgba(128,128,128,0.2); border-top: 4px solid var(--neon-cyan); border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 30px; background: var(--neon-purple); color: white; padding: 16px 32px; border-radius: 50px; z-index: 300; font-weight: 900; box-shadow: 0 15px 35px var(--shadow-color); border: 2px solid rgba(255,255,255,0.2); }
        
        .shake-effect { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }
    </style>
</head>
<body class="is-menu">

<div id="game-container">
    <div class="grid-bg"><div class="grid-bg-inner"></div></div>
    <div id="media-bg-container"></div>
    <canvas id="visualizer-canvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    
    <button id="theme-toggle" title="Switch Theme">üåô</button>
    <button id="skip-intro-btn" data-i18n="btn_skip_intro">„Ç§„É≥„Éà„É≠„Çí„Çπ„Ç≠„ÉÉ„Éó</button>

    <div id="ui-layer">
        <div class="score-display"><span data-i18n="score_label">„Çπ„Ç≥„Ç¢</span>: <span id="score-val">000000</span></div>
        <div id="combo-text" class="combo-display">0</div>
        <div id="judgment-text" class="judgment-display"></div>
    </div>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="start-screen" class="overlay-screen">
        <h1 style="font-size: 38px; margin: 15px 0 30px 0; background: linear-gradient(to bottom, var(--text-color), var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 10px var(--shadow-color)); text-align: center; font-weight: 900; letter-spacing: 4px; flex-shrink: 0;">NEON HERO</h1>
        
        <div class="input-group">
            <span class="input-label" data-i18n="label_player_info">„Éó„É¨„Ç§„É§„ÉºÁôªÈå≤</span>
            <input type="text" id="player-name" data-i18n-placeholder="placeholder_name" maxlength="30">
        </div>

        <div class="input-group">
            <span class="input-label" data-i18n="label_select_track">ÂãïÁîª„Éà„É©„ÉÉ„ÇØ (YOUTUBE)</span>
            <input type="text" id="yt-url" data-i18n-placeholder="placeholder_url">
            <div style="display: flex; gap: 12px; margin-top: 15px;">
                <button class="btn" id="yt-load-btn" style="background: var(--input-bg); color: var(--text-color); border: 2px solid var(--neon-cyan); margin: 0; flex: 1; font-size: 15px; border-radius: 14px;" data-i18n="btn_load">Ë™≠„ÅøËæº„ÇÄ</button>
                <button class="btn hidden" id="yt-share-btn" style="background: var(--neon-purple); margin: 0; flex: 1; font-size: 15px; border-radius: 14px;" data-i18n="btn_share">ÂÖ±Êúâ</button>
            </div>
            <button class="btn" id="open-library-btn" style="background: rgba(0, 153, 255, 0.1); border: 2px solid var(--neon-cyan); color: var(--neon-cyan); margin: 18px 0 0 0; width: 100%; font-size: 14px; border-radius: 14px;">
                <span data-i18n="btn_open_library">„É©„Ç§„Éñ„É©„É™„Åã„ÇâÊõ≤„ÇíÊé¢„Åô</span>
            </button>
            <div id="yt-status" style="font-size: 13px; color: var(--neon-pink); margin-top: 10px; text-align: center; min-height: 18px; font-weight: 800;"></div>
        </div>

        <!-- BPMË®≠ÂÆö„Ç®„É™„Ç¢ÔºàÂæ©Ê¥ª„ÉªÂº∑Ë™øÔºâ -->
        <div class="input-group" id="bpm-group" style="border-color: var(--neon-lime);">
            <span class="input-label" style="color: var(--neon-lime); display: flex; justify-content: space-between;">
                BPM / SYNC
                <span style="font-size:10px; opacity:0.7;">Ê∫ñËá™ÂãïÂêåÊúü</span>
            </span>
            <div class="bpm-control">
                <input type="number" id="bpm-input" value="130" min="60" max="250" step="1">
                <button id="tap-bpm-btn" class="btn" style="margin:0; padding: 14px; font-size: 12px;">TAP to SYNC!</button>
            </div>
            <div id="bpm-message" class="bpm-display">Êõ≤„ÇíËÅ¥„Åç„Å™„Åå„Çâ„Éì„Éº„Éà„ÇíTAP!</div>
            
            <!-- „Éè„Ç§„Éñ„É™„ÉÉ„Éâ„É¢„Éº„ÉâÁî®„Çπ„Ç§„ÉÉ„ÉÅ -->
            <button class="btn hybrid" id="toggle-analysis-btn">üéôÔ∏è PCÈôêÂÆö: „É™„Ç¢„É´„Çø„Ç§„É†Ëß£ÊûêÊºîÂá∫„ÇíON„Å´„Åô„Çã</button>
        </div>

        <div class="input-group">
            <span class="input-label" data-i18n="label_level">Èõ£ÊòìÂ∫¶„É¨„Éô„É´</span>
            <div class="diff-selector" id="diff-selector">
                <button class="diff-btn" data-diff="easy">EASY</button>
                <button class="diff-btn active" data-diff="normal">NORMAL</button>
                <button class="diff-btn" data-diff="hard">HARD</button>
                <button class="diff-btn" data-diff="expert">EXPERT</button>
            </div>
        </div>

        <div id="preview-box">
            <div id="preview-placeholder" data-i18n="preview_placeholder">ÂãïÁîª„ÇíË™≠„ÅøËæº„ÇÄ„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
            <div id="preview-content"></div>
        </div>

        <div id="menu-ranking-container" class="ranking-container hidden">
            <h3 style="font-size: 15px; margin: 0 0 15px 0; text-align: center; color: var(--neon-lime); letter-spacing: 3px; font-weight: 900;" data-i18n="ranking_title">„É©„É≥„Ç≠„É≥„Ç∞</h3>
            <div id="menu-ranking-list" class="ranking-list"></div>
        </div>

        <div style="display: flex; gap: 15px; width: 100%; max-width: 340px; flex-shrink: 0; padding-bottom: 20px;">
            <button class="btn" id="start-btn" disabled data-i18n="btn_ready" style="flex: 2; margin-bottom: 0;">Ê∫ñÂÇôÂÆå‰∫Ü</button>
            <button class="btn" id="open-settings-btn" style="flex: 1; background: var(--panel-bg); border: 1px solid var(--neon-cyan); color: var(--text-color); margin-bottom: 0;">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Ë®≠ÂÆöÁîªÈù¢ -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="width: 100%; max-width: 450px; display: flex; flex-direction: column; height: 100%;">
            <h2 style="text-align: center; color: var(--neon-cyan); margin: 0; font-weight: 900; flex-shrink: 0;" data-i18n="settings_title">Êìç‰ΩúË®≠ÂÆö</h2>
            
            <div class="input-group" style="margin-top: 25px;">
                <span class="input-label" data-i18n="label_key_config">„Ç≠„Éº„Éú„Éº„ÉâË®≠ÂÆö</span>
                <div class="key-config-grid">
                    <button class="key-bind-btn" data-lane="0">
                        <span class="lane-arrow" style="color: var(--neon-cyan);">‚Üê</span>
                        <span class="key-name" id="key-name-0">LEFT</span>
                    </button>
                    <button class="key-bind-btn" data-lane="1">
                        <span class="lane-arrow" style="color: var(--neon-pink);">‚Üì</span>
                        <span class="key-name" id="key-name-1">DOWN</span>
                    </button>
                    <button class="key-bind-btn" data-lane="2">
                        <span class="lane-arrow" style="color: var(--neon-lime);">‚Üë</span>
                        <span class="key-name" id="key-name-2">UP</span>
                    </button>
                    <button class="key-bind-btn" data-lane="3">
                        <span class="lane-arrow" style="color: var(--neon-purple);">‚Üí</span>
                        <span class="key-name" id="key-name-3">RIGHT</span>
                    </button>
                </div>
                <button class="btn" id="reset-keys-btn" style="background: rgba(255, 0, 122, 0.15); border: 1px solid var(--neon-pink); color: var(--neon-pink); margin: 20px auto 0 auto; width: 100%; font-size: 14px; border-radius: 14px; box-shadow: none;" data-i18n="btn_reset">„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                <button class="btn" id="cleanup-tiktok-btn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid #444; color: #888; margin: 10px auto 0 auto; width: 100%; font-size: 11px; border-radius: 10px; box-shadow: none;">TikTok„Éá„Éº„Çø„ÇíÊ∂àÂéª (ÁÆ°ÁêÜËÄÖÁî®)</button>
            </div>

            <div class="input-group" style="margin-top: 0;">
                <span class="input-label" data-i18n="label_gamepad">„Ç≤„Éº„É†„Éë„ÉÉ„ÉâÁä∂ÊÖã</span>
                <div id="gamepad-status" style="text-align:center; font-size: 14px; font-weight: bold; color: var(--neon-lime);">Êú™Êé•Á∂ö</div>
            </div>

            <button class="btn" id="close-settings-btn" style="background: #1e293b; margin: auto auto 0 auto; border-radius: 14px; flex-shrink: 0;" data-i18n="btn_close">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- „É™„Ç∂„É´„ÉàÁîªÈù¢ -->
    <div id="result-screen" class="overlay-screen hidden">
        <h2 style="color: var(--neon-cyan); margin: 25px 0 15px 0; font-size: 32px; font-weight: 900; letter-spacing: 4px;" data-i18n="result_title">STAGE CLEAR!</h2>
        <div style="font-size: 64px; margin-bottom: 15px; color: var(--text-color); text-shadow: 0 0 30px var(--neon-cyan); font-weight: 900;" id="final-score">0</div>
        <div id="stats-detail" style="text-align: center; font-size: 15px; color: var(--text-color); opacity: 0.9; margin-bottom: 25px; line-height: 1.8;"></div>
        
        <div class="input-group" id="score-reg-panel">
            <span class="input-label" data-i18n="label_comment">‰∏ÄË®Ä„Ç≥„É°„É≥„Éà„ÇíÊÆã„Åô</span>
            <input type="text" id="player-comment" data-i18n-placeholder="placeholder_comment" maxlength="30">
            <button class="btn" id="register-score-btn" style="margin: 20px 0 0 0; width: 100%; font-size: 15px;" data-i18n="btn_register">„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤</button>
        </div>

        <div class="ranking-container">
            <h3 style="font-size: 18px; margin: 0 0 20px 0; text-align: center; color: var(--neon-cyan); letter-spacing: 4px; font-weight: 900;" data-i18n="ranking_world">WORLD RANKING</h3>
            <div id="result-ranking-list" class="ranking-list"><div class="loader"></div></div>
        </div>

        <button class="btn" id="retry-btn" data-i18n="btn_back">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
    </div>

    <!-- „É©„Ç§„Éñ„É©„É™„É¢„Éº„ÉÄ„É´ -->
    <div id="library-modal" class="modal">
        <div class="modal-content" style="width: 100%; max-width: 500px; display: flex; flex-direction: column; height: 100%;">
            <h2 style="text-align: center; color: var(--neon-cyan); margin: 0; font-weight: 900; letter-spacing: 3px; flex-shrink: 0;">SHARED LIBRARY</h2>
            <p style="text-align: center; color: var(--text-color); opacity: 0.7; font-size: 13px; margin-bottom: 20px; flex-shrink: 0;" data-i18n="library_desc">„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊõ≤</p>
            
            <div class="library-tabs" id="library-tabs">
                <button class="tab-btn active" data-mode="new" data-i18n="tab_new">Êñ∞ÁùÄÈ†Ü</button>
                <button class="tab-btn" data-mode="daily" data-i18n="tab_daily">Êó•Âà•‰∫∫Ê∞ó</button>
                <button class="tab-btn" data-mode="weekly" data-i18n="tab_weekly">ÈÄ±Âà•‰∫∫Ê∞ó</button>
                <button class="tab-btn" data-mode="monthly" data-i18n="tab_monthly">ÊúàÂà•‰∫∫Ê∞ó</button>
            </div>

            <div id="shared-list-full" style="flex-grow: 1; overflow-y: auto;">
                <div class="loader"></div>
            </div>
            <button class="btn" id="close-library-btn" style="background: #1e293b; margin: 30px auto 0 auto; border-radius: 14px; flex-shrink: 0;" data-i18n="btn_close">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <div id="touch-controls">
        <div class="touch-btn" id="btn-0" data-key="ArrowLeft">‚Üê</div>
        <div class="touch-btn" id="btn-1" data-key="ArrowDown">‚Üì</div>
        <div class="touch-btn" id="btn-2" data-key="ArrowUp">‚Üë</div>
        <div class="touch-btn" id="btn-3" data-key="ArrowRight">‚Üí</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const myFirebaseConfig = {
        apiKey: "AIzaSyBiCTU35eBaVXhTfnd-XDifHDDxXZALQCM",
        authDomain: "neon-hero-2b368.firebaseapp.com",
        projectId: "neon-hero-2b368",
        storageBucket: "neon-hero-2b368.firebasestorage.app",
        messagingSenderId: "904605896059",
        appId: "1:904605896059:web:87c5ab4437041e01e381de"
    };

    const firebaseConfig = (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) 
        ? JSON.parse(window.__firebase_config) 
        : myFirebaseConfig;
    
    const targetAppId = (typeof window.__app_id !== 'undefined' && window.__app_id) 
        ? window.__app_id 
        : 'neon-hero-v5-prism';
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    const initAuth = async () => {
        try { await signInAnonymously(auth); } catch (e) { console.error("Firebase Auth Error: ", e); }
    };
    initAuth();
    onAuthStateChanged(auth, user => currentUser = user);

    window.saveGameScore = async (data) => {
        if (!currentUser) return;
        try {
            const scoresCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'scores');
            await addDoc(scoresCol, { ...data, userId: currentUser.uid, timestamp: Date.now() });
        } catch (e) { console.error(e); }
    };

    window.fetchRankings = async (videoId, difficulty) => {
        if (!currentUser) return [];
        try {
            const scoresCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'scores');
            const snapshot = await getDocs(scoresCol);
            const list = [];
            snapshot.forEach(doc => {
                const item = doc.data();
                if (item.videoId === videoId && item.difficulty === difficulty) list.push(item);
            });
            return list.sort((a, b) => b.score - a.score).slice(0, 10);
        } catch (e) { return []; }
    };

    window.registerSharedVideo = async (videoId, title, duration, bpm = null) => {
        if (!currentUser) return;
        try {
            const sharedCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'shared_videos');
            const snapshot = await getDocs(sharedCol);
            let existingId = null;
            let currentData = {};
            snapshot.forEach(d => { if (d.data().videoId === videoId) { existingId = d.id; currentData = d.data(); } });
            
            if (!existingId) {
                await addDoc(sharedCol, { videoId, title, duration, bpm, timestamp: Date.now(), provider: 'youtube' });
            } else {
                const videoDoc = doc(db, 'artifacts', targetAppId, 'public', 'data', 'shared_videos', existingId);
                const updates = { provider: 'youtube' };
                if (duration) updates.duration = duration;
                if (bpm) updates.bpm = bpm;
                await updateDoc(videoDoc, updates);
            }
        } catch (e) { console.error(e); }
    };

    window.recordPlay = async (videoId, title) => {
        if (!currentUser) return;
        try {
            const logsCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'play_logs');
            await addDoc(logsCol, { videoId, title, timestamp: Date.now() });
        } catch (e) { console.error(e); }
    };

    window.fetchSharedVideos = async () => {
        if (!currentUser) return [];
        try {
            const sharedCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'shared_videos');
            const snapshot = await getDocs(sharedCol);
            const list = [];
            snapshot.forEach(doc => list.push(doc.data()));
            return list.sort((a, b) => b.timestamp - a.timestamp);
        } catch (e) { return []; }
    };

    window.fetchPlayLogs = async () => {
        if (!currentUser) return [];
        try {
            const logsCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'play_logs');
            const snapshot = await getDocs(logsCol);
            const list = [];
            snapshot.forEach(doc => list.push(doc.data()));
            return list;
        } catch (e) { return []; }
    };

    // TikTok„Éá„Éº„ÇøÊäπÊ∂àÈñ¢Êï∞
    window.cleanupTikTokData = async () => {
        if (!currentUser) return;
        try {
            const sharedCol = collection(db, 'artifacts', targetAppId, 'public', 'data', 'shared_videos');
            const snapshot = await getDocs(sharedCol);
            let count = 0;
            for (const d of snapshot.docs) {
                if (d.data().provider === 'tiktok') {
                    await deleteDoc(doc(db, 'artifacts', targetAppId, 'public', 'data', 'shared_videos', d.id));
                    count++;
                }
            }
            return count;
        } catch (e) { console.error(e); return -1; }
    };
</script>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
/**
 * „ÇØ„É©„Ç§„Ç¢„É≥„Éà„É≠„Ç∏„ÉÉ„ÇØ
 */

const translations = {
    ja: {
        score_label: "„Çπ„Ç≥„Ç¢",
        label_player_info: "„Éó„É¨„Ç§„É§„ÉºÁôªÈå≤",
        placeholder_name: "ÂêçÂâç#„Éë„Çπ„ÉØ„Éº„Éâ„Åß„Éà„É™„ÉÉ„Éó...",
        label_select_track: "ÂãïÁîª„Éà„É©„ÉÉ„ÇØ (YOUTUBE)",
        placeholder_url: "YouTube„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë",
        btn_load: "Ë™≠„ÅøËæº„ÇÄ",
        btn_share: "ÂÖ±Êúâ",
        btn_open_library: "„É©„Ç§„Éñ„É©„É™„Åã„ÇâÊõ≤„ÇíÊé¢„Åô",
        preview_placeholder: "ÂãïÁîª„ÇíË™≠„ÅøËæº„ÇÄ„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô",
        ranking_title: "„Åì„ÅÆÊõ≤„ÅÆ„Éà„ÉÉ„Éó„É©„É≥„Ç´„Éº",
        btn_ready: "Ê∫ñÂÇôÂÆå‰∫Ü",
        result_title: "STAGE CLEAR!",
        label_comment: "‰∏ÄË®Ä„Ç≥„É°„É≥„Éà„ÇíÊÆã„Åô",
        placeholder_comment: "‰ªäÊó•„ÅÆÊ∞óÂàÜ„ÅØÔºü",
        btn_register: "„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤",
        ranking_world: "WORLD RANKING",
        btn_back: "„É°„Éã„É•„Éº„Å´Êàª„Çã",
        library_desc: "„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊõ≤",
        btn_close: "Èñâ„Åò„Çã",
        msg_loading: "Ë™≠„ÅøËæº„Åø‰∏≠...",
        msg_ready: "Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ",
        msg_error: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
        msg_no_records: "„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
        msg_copied: "„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ",
        stats_perfect: "„Éë„Éº„Éï„Çß„ÇØ„Éà",
        stats_great: "„Ç∞„É¨„Éº„Éà",
        stats_good: "„Ç∞„ÉÉ„Éâ",
        stats_miss: "„Éü„Çπ",
        stats_combo: "ÊúÄÂ§ß„Ç≥„É≥„Éú",
        tab_new: "Êñ∞ÁùÄÈ†Ü",
        tab_daily: "Êó•Âà•‰∫∫Ê∞ó",
        tab_weekly: "ÈÄ±Âà•‰∫∫Ê∞ó",
        tab_monthly: "ÊúàÂà•‰∫∫Ê∞ó",
        plays_suffix: "Âõû„Éó„É¨„Ç§",
        settings_title: "Êìç‰ΩúË®≠ÂÆö",
        label_key_config: "„Ç≠„Éº„Éú„Éº„ÉâË®≠ÂÆö",
        label_gamepad: "„Ç≤„Éº„É†„Éë„ÉÉ„ÉâÁä∂ÊÖã",
        msg_gamepad_on: "Êé•Á∂öÊ∏à„Åø",
        msg_gamepad_off: "Êú™Êé•Á∂ö",
        btn_skip_intro: "„Ç§„É≥„Éà„É≠„Çí„Çπ„Ç≠„ÉÉ„Éó",
        btn_reset: "„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô",
        msg_reset_done: "ÂàùÊúüË®≠ÂÆö„Å´Êàª„Åó„Åæ„Åó„Åü"
    },
    en: {
        score_label: "SCORE",
        label_player_info: "PLAYER REGISTRATION",
        placeholder_name: "Name#password for trip...",
        label_select_track: "VIDEO TRACK (YOUTUBE)",
        placeholder_url: "Paste YouTube URL",
        btn_load: "LOAD",
        btn_share: "SHARE",
        btn_open_library: "OPEN LIBRARY",
        preview_placeholder: "TRACK PREVIEW AREA",
        ranking_title: "TOP RANKERS",
        btn_ready: "READY",
        result_title: "STAGE CLEAR!",
        label_comment: "LEAVE A COMMENT",
        placeholder_comment: "How was the play?",
        btn_register: "REGISTER SCORE",
        ranking_world: "WORLD RANKING",
        btn_back: "BACK TO MENU",
        library_desc: "Community's Favorite Tracks",
        btn_close: "CLOSE",
        msg_loading: "Loading...",
        msg_ready: "READY!",
        msg_error: "ERROR OCCURRED",
        msg_no_records: "NO RECORDS YET",
        msg_copied: "Link copied!",
        stats_perfect: "PERFECT",
        stats_great: "GREAT",
        stats_good: "GOOD",
        stats_miss: "MISS",
        stats_combo: "MAX COMBO",
        tab_new: "Latest",
        tab_daily: "Daily",
        tab_weekly: "Weekly",
        tab_monthly: "Monthly",
        plays_suffix: " plays",
        settings_title: "SETTINGS",
        label_key_config: "KEYBOARD CONFIG",
        label_gamepad: "GAMEPAD STATUS",
        msg_gamepad_on: "CONNECTED",
        msg_gamepad_off: "DISCONNECTED",
        btn_skip_intro: "SKIP INTRO",
        btn_reset: "RESET TO DEFAULT",
        msg_reset_done: "Keys reset to default"
    }
};

const gameContainer = document.getElementById('game-container');
const canvas = document.getElementById('gameCanvas');
const visualizerCanvas = document.getElementById('visualizer-canvas');
const ctx = canvas.getContext('2d');
const vCtx = visualizerCanvas.getContext('2d');
const mediaBgContainer = document.getElementById('media-bg-container');
const previewContent = document.getElementById('preview-content');
const previewPlaceholder = document.getElementById('preview-placeholder');
const sharedListFull = document.getElementById('shared-list-full');
const libraryModal = document.getElementById('library-modal');
const settingsModal = document.getElementById('settings-modal');
const openSettingsBtn = document.getElementById('open-settings-btn');
const closeSettingsBtn = document.getElementById('close-settings-btn');
const resetKeysBtn = document.getElementById('reset-keys-btn');
const cleanupTiktokBtn = document.getElementById('cleanup-tiktok-btn');
const openLibraryBtn = document.getElementById('open-library-btn');
const closeLibraryBtn = document.getElementById('close-library-btn');
const skipIntroBtn = document.getElementById('skip-intro-btn');
const startBtn = document.getElementById('start-btn');
const toggleAnalysisBtn = document.getElementById('toggle-analysis-btn');
const ytLoadBtn = document.getElementById('yt-load-btn');
const ytShareBtn = document.getElementById('yt-share-btn');
const registerScoreBtn = document.getElementById('register-score-btn');
const retryBtn = document.getElementById('retry-btn');
const startScreen = document.getElementById('start-screen');
const resultScreen = document.getElementById('result-screen');
const scoreVal = document.getElementById('score-val');
const comboText = document.getElementById('combo-text');
const judgmentText = document.getElementById('judgment-text');
const ytStatus = document.getElementById('yt-status');
const diffSelector = document.getElementById('diff-selector');
const menuRankingContainer = document.getElementById('menu-ranking-container');
const menuRankingList = document.getElementById('menu-ranking-list');
const resultRankingList = document.getElementById('result-ranking-list');
const playerNameInput = document.getElementById('player-name');
const playerCommentInput = document.getElementById('player-comment');
const ytUrlInput = document.getElementById('yt-url');
const themeToggle = document.getElementById('theme-toggle');
const libraryTabs = document.getElementById('library-tabs');
const gamepadStatus = document.getElementById('gamepad-status');
const tapBpmBtn = document.getElementById('tap-bpm-btn');
const bpmInput = document.getElementById('bpm-input');
const bpmMessage = document.getElementById('bpm-message');

const LANE_COUNT = 4;
const JUDGMENT_MS = { PERFECT: 60, GREAT: 110, GOOD: 160, MISS: 250 };
const HIT_LINE_Y = 0.82;
const CORE_COLORS = ['#00f2ff', '#ff007a', '#bcff00', '#9d00ff'];

const DIFFICULTY_CONFIG = {
    easy:   { speed: 0.45, density: 0.5 },
    normal: { speed: 0.60, density: 1.0 },
    hard:   { speed: 0.75, density: 1.5 },
    expert: { speed: 0.95, density: 2.0 }
};

const DEFAULT_KEYS = ["arrowleft", "arrowdown", "arrowup", "arrowright"];
let currentDiff = 'normal';
let gameState = 'START';
let playMode = 'NONE'; // 'NONE', 'VIDEO' (Analysis is now a flag)
let isAnalysisEnabled = false;
let score = 0, combo = 0, maxCombo = 0;
let notes = [];
let gameStartTime = 0;
let stats = { perfect: 0, great: 0, good: 0, miss: 0 };
let activeLanes = [false, false, false, false];
let particles = [];
let currentVideoId = "";
let currentDuration = 0;
let ytPlayer;
let currentLang = 'en';
let uiText = translations.en;
let tapTimes = [];
let lastTapVideoTime = 0; 

// Audio Analysis Variables
let audioContext, analyser, dataArray, source;
let analysisStream = null;
let lastNoteTime = 0;
let energyHistory = [];

// „Ç≠„Éº„Ç≥„É≥„Éï„Ç£„Ç∞
let keyBindings = JSON.parse(localStorage.getItem('neon-hero-keys')) || [...DEFAULT_KEYS];
let isBindingKey = null;

function initI18n() {
    currentLang = navigator.language.startsWith('ja') ? 'ja' : 'en';
    uiText = translations[currentLang];
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        el.innerText = uiText[el.dataset.i18n] || el.innerText;
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (uiText[key]) el.placeholder = uiText[key];
    });
}

initI18n();

function formatDuration(seconds) {
    if (!seconds) return "";
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
}

playerNameInput.value = localStorage.getItem('neon-hero-player-name-raw') || "";
if (localStorage.getItem('neon-hero-theme') === 'light') {
    document.body.classList.add('light-mode');
    themeToggle.innerText = '‚òÄÔ∏è';
}

themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    themeToggle.innerText = isLight ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('neon-hero-theme', isLight ? 'light' : 'dark');
});

function updateKeyConfigUI() {
    keyBindings.forEach((key, idx) => {
        const el = document.getElementById(`key-name-${idx}`);
        if (el) el.innerText = key.toUpperCase().replace('ARROW', '');
    });
}
updateKeyConfigUI();

document.querySelectorAll('.key-bind-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        isBindingKey = parseInt(btn.dataset.lane);
        btn.classList.add('waiting');
        btn.querySelector('.key-name').innerText = "...";
    });
});

openSettingsBtn.addEventListener('click', () => settingsModal.classList.add('is-visible'));
closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('is-visible');
    isBindingKey = null;
    document.querySelectorAll('.key-bind-btn').forEach(b => b.classList.remove('waiting'));
    updateKeyConfigUI();
});

resetKeysBtn.addEventListener('click', () => {
    keyBindings = [...DEFAULT_KEYS];
    localStorage.setItem('neon-hero-keys', JSON.stringify(keyBindings));
    updateKeyConfigUI();
    showToast(uiText.msg_reset_done);
});

// TikTok„Éá„Éº„ÇøÂâäÈô§ÂÆüË°å
cleanupTiktokBtn.addEventListener('click', async () => {
    if (!confirm("TikTok„ÅÆÂ±•Ê≠¥„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
    cleanupTiktokBtn.disabled = true;
    cleanupTiktokBtn.innerText = "ÂâäÈô§‰∏≠...";
    const count = await window.cleanupTikTokData();
    cleanupTiktokBtn.disabled = false;
    cleanupTiktokBtn.innerText = "TikTok„Éá„Éº„Çø„ÇíÊ∂àÂéª (ÁÆ°ÁêÜËÄÖÁî®)";
    showToast(`${count}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
});

// BPM Tap Logic
tapBpmBtn.addEventListener('click', () => {
    const now = Date.now();
    const videoTime = getCurrentTimeMs(); // ÂãïÁîª„ÅÆÁèæÂú®ÊôÇÈñì„ÇíÂèñÂæó

    // 2Áßí‰ª•‰∏äÈñìÈöî„ÅåÁ©∫„ÅÑ„Åü„Çâ„É™„Çª„ÉÉ„Éà
    if (tapTimes.length > 0 && now - tapTimes[tapTimes.length - 1] > 2000) {
        tapTimes = [];
        bpmMessage.innerText = "Reset. Tap again!";
    }
    
    tapTimes.push(now);
    lastTapVideoTime = videoTime; // ÂãïÁîª‰∏ä„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Çí‰øùÂ≠ò
    
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
    tapBpmBtn.style.transform = "scale(0.9)";
    setTimeout(() => tapBpmBtn.style.transform = "scale(1)", 100);

    if (tapTimes.length >= 4) {
        // Áõ¥Ëøë8Âõû„ÅÆÂπ≥Âùá„ÇíÂèñ„Çã
        const relevantTaps = tapTimes.slice(-8); 
        let intervals = [];
        for (let i = 1; i < relevantTaps.length; i++) {
            intervals.push(relevantTaps[i] - relevantTaps[i-1]);
        }
        const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
        const bpm = Math.round(60000 / avgInterval);
        
        // ÁØÑÂõ≤Âà∂Èôê
        if (bpm >= 60 && bpm <= 300) {
            bpmInput.value = bpm;
            bpmMessage.innerText = `SYNCED: ${bpm} BPM`;
            bpmMessage.style.color = "var(--neon-lime)";
            
            // BPM‰øùÂ≠ò
            localStorage.setItem('lastBpm', bpm);

            // BPM„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Çâ„Éû„ÉÉ„ÉóÂÜçÁîüÊàê („Ç™„Éï„Çª„ÉÉ„ÉàÊÉÖÂ†±‰ªò„Åç)
            if (currentDuration > 0) {
                notes = generateMap(currentDuration, currentVideoId);
                showToast(`BPM:${bpm} „ÅßË≠úÈù¢„ÇíÂÜçÊßãÁØâ„Åó„Åæ„Åó„Åü`);
            }
        }
    } else {
        bpmMessage.innerText = `Keep tapping... (${tapTimes.length})`;
    }
});
// ÊâãÂãïÂÖ•ÂäõÊôÇ„ÇÇÂÜçÁîüÊàê
bpmInput.addEventListener('change', () => {
    const bpm = parseInt(bpmInput.value);
    localStorage.setItem('lastBpm', bpm);
    if (currentDuration > 0) {
        notes = generateMap(currentDuration, currentVideoId);
    }
});


function skipIntro() {
    if (ytPlayer && notes.length > 0) {
        const firstNoteTime = notes[0].time;
        const seekTarget = Math.max(0, (firstNoteTime - 2000) / 1000);
        ytPlayer.seekTo(seekTarget, true);
        skipIntroBtn.style.display = 'none';
    }
}
skipIntroBtn.addEventListener('click', skipIntro);

function pollGamepad() {
    const gamepads = navigator.getGamepads();
    if (!gamepads[0]) {
        gamepadStatus.innerText = uiText.msg_gamepad_off;
        gamepadStatus.style.color = "var(--neon-pink)";
        return;
    }
    gamepadStatus.innerText = uiText.msg_gamepad_on;
    gamepadStatus.style.color = "var(--neon-lime)";
    if (gameState !== 'PLAYING') return;
    const gp = gamepads[0];
    const btnMap = [
        gp.buttons[14]?.pressed || gp.buttons[0]?.pressed,
        gp.buttons[13]?.pressed || gp.buttons[1]?.pressed,
        gp.buttons[12]?.pressed || gp.buttons[3]?.pressed,
        gp.buttons[15]?.pressed || gp.buttons[2]?.pressed
    ];
    btnMap.forEach((isPressed, idx) => {
        if (isPressed && !activeLanes[idx]) { activeLanes[idx] = true; checkHit(idx); }
        else if (!isPressed && activeLanes[idx]) { activeLanes[idx] = false; }
    });
}

function handleKeyDown(key) {
    const k = key.toLowerCase();
    if (isBindingKey !== null) {
        keyBindings[isBindingKey] = k;
        localStorage.setItem('neon-hero-keys', JSON.stringify(keyBindings));
        isBindingKey = null;
        document.querySelectorAll('.key-bind-btn').forEach(b => b.classList.remove('waiting'));
        updateKeyConfigUI();
        return;
    }
    if (gameState !== 'PLAYING') return;
    const laneIdx = keyBindings.indexOf(k);
    if (laneIdx !== -1 && !activeLanes[laneIdx]) {
        activeLanes[laneIdx] = true;
        const btn = document.getElementById(`btn-${laneIdx}`);
        if (btn) btn.classList.add('active');
        checkHit(laneIdx);
    }
}

function handleKeyUp(key) {
    const k = key.toLowerCase();
    const laneIdx = keyBindings.indexOf(k);
    if (laneIdx !== -1) {
        activeLanes[laneIdx] = false;
        const btn = document.getElementById(`btn-${laneIdx}`);
        if (btn) btn.classList.remove('active');
    }
}

async function generateTrip(password) {
    if (!password) return "";
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const base64 = btoa(String.fromCharCode(...hashArray));
    return " ‚óÜ" + base64.substring(0, 10).replace(/\+/g, '.').replace(/\//g, '_');
}

async function parsePlayerName(rawName) {
    const parts = rawName.split('#');
    const name = parts[0] || (currentLang === 'ja' ? 'ÂêçÁÑ°„Åó' : 'Anonymous');
    const trip = parts.length > 1 ? await generateTrip(parts[1]) : "";
    return { name, trip };
}

openLibraryBtn.addEventListener('click', () => {
    libraryModal.classList.add('is-visible');
    renderLibrary('new');
});

closeLibraryBtn.addEventListener('click', () => libraryModal.classList.remove('is-visible'));

libraryTabs.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderLibrary(btn.dataset.mode);
});

diffSelector.addEventListener('click', (e) => {
    const target = e.target.closest('.diff-btn');
    if (target) {
        document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
        target.classList.add('active');
        currentDiff = target.dataset.diff;
        if (currentDuration > 0) {
            notes = generateMap(currentDuration, currentVideoId);
            updateRankingDisplay(currentVideoId, currentDiff, menuRankingList, menuRankingContainer);
        }
    }
});

async function renderLibrary(mode) {
    sharedListFull.innerHTML = '<div class="loader"></div>';
    if (typeof window.fetchSharedVideos !== 'function' || typeof window.fetchPlayLogs !== 'function') return;

    const [videos, logs] = await Promise.all([window.fetchSharedVideos(), window.fetchPlayLogs()]);
    let displayList = [];
    const now = Date.now();
    const periods = { daily: 86400000, weekly: 604800000, monthly: 2592000000 };

    if (mode === 'new') {
        displayList = videos.map(v => ({...v, playCount: logs.filter(l => l.videoId === v.videoId).length}));
    } else {
        const threshold = periods[mode];
        const recentLogs = logs.filter(l => (now - l.timestamp) < threshold);
        const counts = recentLogs.reduce((acc, log) => { acc[log.videoId] = (acc[log.videoId] || 0) + 1; return acc; }, {});
        displayList = Object.entries(counts).map(([videoId, count]) => {
            const video = videos.find(v => v.videoId === videoId);
            return video ? { ...video, playCount: count } : null;
        }).filter(v => v !== null).sort((a, b) => b.playCount - a.playCount);
    }

    if (displayList.length === 0) {
        sharedListFull.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5;">${uiText.msg_no_records}</div>`;
        return;
    }

    sharedListFull.innerHTML = displayList.map(v => {
        // TikTok„Éá„Éº„Çø„ÅåÊ∑∑„Åñ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const thumb = v.provider === 'tiktok' ? 'https://www.tiktok.com/favicon.ico' : `https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg`;
        const bpmDisplay = v.bpm ? `<span style="color:var(--neon-lime); font-size:10px; margin-left:5px;">BPM:${v.bpm}</span>` : "";
        return `
        <div class="shared-item-full" data-id="${v.videoId}" data-bpm="${v.bpm || ''}">
            <span class="play-count-badge">${v.playCount}${uiText.plays_suffix}</span>
            <div class="thumbnail-container">
                <img src="${thumb}" class="shared-thumbnail" onerror="this.src='https://via.placeholder.com/120x68?text=No+Image'">
                ${v.duration ? `<span class="duration-badge">${formatDuration(v.duration)}</span>` : ""}
            </div>
            <div class="shared-item-info">
                <div class="shared-item-title">${v.title || "Untitled Track"} ${bpmDisplay}</div>
            </div>
        </div>
    `}).join('');
    
    document.querySelectorAll('.shared-item-full').forEach(item => {
        item.addEventListener('click', () => {
            ytUrlInput.value = `https://www.youtube.com/watch?v=${item.dataset.id}`;
            const savedBpm = item.dataset.bpm;
            if (savedBpm && savedBpm !== "undefined") {
                bpmInput.value = savedBpm;
                bpmMessage.innerText = `Loaded: ${savedBpm} BPM`;
            }
            loadYoutube(item.dataset.id);
            libraryModal.classList.remove('is-visible');
        });
    });
}

function extractYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function loadYoutube(vidId) {
    currentVideoId = vidId;
    localStorage.setItem('lastVideoId', vidId); // ÂãïÁîªID„Çí‰øùÂ≠ò
    
    ytStatus.innerHTML = `<div class="loader"></div> ${uiText.msg_loading}`;
    previewPlaceholder.classList.add('hidden');
    previewContent.innerHTML = '<div id="yt-player-target"></div>';
    const safeOrigin = window.location.protocol === 'file:' ? 'https://www.youtube.com' : window.location.origin;
    ytPlayer = new YT.Player('yt-player-target', {
        height: '100%', width: '100%', videoId: vidId,
        playerVars: { 'autoplay': 1, 'controls': 1, 'origin': safeOrigin, 'enablejsapi': 1, 'modestbranding': 1, 'mute': 0 },
        events: {
            'onReady': (e) => {
                const duration = e.target.getDuration();
                if (duration === 0) { ytStatus.innerText = uiText.msg_error; return; }
                currentDuration = duration;
                notes = generateMap(currentDuration, vidId);
                playMode = 'VIDEO';
                ytStatus.innerText = uiText.msg_ready;
                startBtn.disabled = false;
                toggleAnalysisBtn.style.display = 'block'; // ÂãïÁîªË™≠„ÅøËæº„ÅøÂæå„Å´Ë°®Á§∫
                ytShareBtn.classList.remove('hidden');
                updateRankingDisplay(currentVideoId, currentDiff, menuRankingList, menuRankingContainer);
                // BPM„ÇÇ‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„Å´ÁôªÈå≤Èñ¢Êï∞„ÇíÊõ¥Êñ∞ÔºàÈùûÂêåÊúü„ÅßOKÔºâ
                window.registerSharedVideo(vidId, ytPlayer.getVideoData().title, Math.floor(duration), parseInt(bpmInput.value));
                e.target.unMute();
                e.target.setVolume(50); 
            },
            'onError': (e) => { ytStatus.innerText = uiText.msg_error; }
        }
    });
}

ytLoadBtn.addEventListener('click', () => {
    const vidId = extractYoutubeId(ytUrlInput.value);
    if (vidId) loadYoutube(vidId); else ytStatus.innerText = uiText.msg_error;
});

ytShareBtn.addEventListener('click', () => {
    const shareUrl = `${window.location.origin}${window.location.pathname}?v=${currentVideoId}`;
    const tempInput = document.createElement("input");
    tempInput.value = shareUrl; document.body.appendChild(tempInput); tempInput.select();
    document.execCommand("copy"); document.body.removeChild(tempInput);
    showToast(uiText.msg_copied);
});

function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "toast"; toast.innerText = msg;
    document.body.appendChild(toast); setTimeout(() => toast.remove(), 2500);
}

// „Ç∑„Éº„Éâ‰ªò„Åç‰π±Êï∞ÁîüÊàê„ÇØ„É©„Çπ
class SeededRandom {
    constructor(seedString) {
        let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
        for (let i = 0, k; i < seedString.length; i++) {
            k = seedString.charCodeAt(i);
            h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
            h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
            h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
            h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
        }
        h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
        h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
        h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
        h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
        this.a = h1 >>> 0; this.b = h2 >>> 0; this.c = h3 >>> 0; this.d = h4 >>> 0;
    }
    next() {
        this.a >>>= 0; this.b >>>= 0; this.c >>>= 0; this.d >>>= 0; 
        let t = (this.a + this.b) | 0;
        this.a = this.b ^ (this.b >>> 9);
        this.b = (this.c + (this.c << 3)) | 0;
        this.c = (this.c << 21) | (this.c >>> 11);
        this.d = (this.d + 1) | 0;
        t = (t + this.d) | 0;
        this.c = (this.c + t) | 0;
        return (t >>> 0) / 4294967296;
    }
}

function generateMap(durationSeconds, seedStr = "default") {
    const map = [];
    const config = DIFFICULTY_CONFIG[currentDiff];
    
    const rng = new SeededRandom(seedStr + currentDiff);
    
    const bpm = parseInt(bpmInput.value) || 130;
    const beatInterval = 60000 / bpm; 
    
    let startOffset = 2500;
    
    if (lastTapVideoTime > 0) {
        const rawRem = lastTapVideoTime % beatInterval;
        startOffset = rawRem;
        while(startOffset < 2000) {
            startOffset += beatInterval;
        }
    }

    const endOffset = durationSeconds * 1000 - 2000;
    
    let currentBeat = 0;
    let currentTime = startOffset;
    const noteProb = config.density; 

    while (currentTime < endOffset) {
        let isNote = rng.next() < (noteProb * 0.8);
        const measure = Math.floor(currentBeat / 4);
        const isChorus = (measure % 8 >= 4); 
        
        if (isChorus) {
            isNote = rng.next() < (noteProb * 1.2);
            if ((currentDiff === 'hard' || currentDiff === 'expert') && rng.next() < 0.4) {
                 const eighthTime = currentTime + (beatInterval / 2);
                 if (eighthTime < endOffset) {
                    map.push({ time: eighthTime, lane: Math.floor(rng.next() * LANE_COUNT), hit: false });
                 }
            }
        }

        if (isNote) {
            map.push({ time: currentTime, lane: Math.floor(rng.next() * LANE_COUNT), hit: false });
            if ((currentDiff === 'expert') && rng.next() < 0.2) {
                map.push({ time: currentTime, lane: (Math.floor(rng.next() * LANE_COUNT) + 1) % LANE_COUNT, hit: false });
            }
        }

        currentTime += beatInterval;
        currentBeat++;
    }
    return map.sort((a,b) => a.time - b.time);
}

function getCurrentTimeMs() {
    return (playMode === 'VIDEO' && ytPlayer?.getCurrentTime) ? ytPlayer.getCurrentTime() * 1000 : 0;
}

// ------ Hybrid Audio Analysis ------
async function setupAudioAnalysis() {
    try {
        if (!navigator.mediaDevices.getDisplayMedia) {
            alert("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÁîªÈù¢ÂÖ±ÊúâÈü≥Â£∞„Ç≠„É£„Éó„ÉÅ„É£„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
            return false;
        }

        // --- „Çè„Åã„Çä„ÇÑ„Åô„ÅÑÊ°àÂÜÖ„ÇíËøΩÂä† ---
        alert("„ÄêÈáçË¶ÅÔºöÂÖ±ÊúâÁîªÈù¢„ÅÆÈÅ∏„Å≥Êñπ„Äë\n\n1. Âá∫„Å¶„Åç„Åü„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆ„ÄåChrome „Çø„Éñ„Äç„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇ\n2. „É™„Çπ„Éà„ÅÆ‰∏≠„Åã„Çâ„Äådma-cmyk.github.io„Äç„Åæ„Åü„ÅØ„Äå„Éç„Ç™„É≥„Éª„Éí„Éº„É≠„Éº„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ\n3. „Äå„Çø„Éñ„ÅÆÈü≥Â£∞„ÇÇÂÖ±Êúâ„Åô„Çã„Äç„ÇíON„Å´„Åó„Å¶„ÄåÂÖ±Êúâ„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");

        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: {
                echoCancellation: false,
                autoGainControl: false,
                noiseSuppression: false,
                channelCount: 2
            }
        });

        const audioTrack = stream.getAudioTracks()[0];
        if (!audioTrack) {
            alert("Èü≥Â£∞„ÅåÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Äå„Ç∑„Çπ„ÉÜ„É†„Ç™„Éº„Éá„Ç£„Ç™„ÇíÂÖ±Êúâ„Äç„Åæ„Åü„ÅØ„Äå„Çø„Éñ„ÅÆÈü≥Â£∞„ÇíÂÖ±Êúâ„Äç„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            stream.getTracks().forEach(t => t.stop());
            return false;
        }

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analysisStream = stream;
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        isAnalysisEnabled = true;
        toggleAnalysisBtn.classList.add('active');
        toggleAnalysisBtn.innerText = "„É™„Ç¢„É´„Çø„Ç§„É†Ëß£Êûê‰∏≠ (ON)";
        
        // „É¶„Éº„Ç∂„Éº„ÅåÂÖ±ÊúâÂÅúÊ≠¢„Åó„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
        audioTrack.onended = () => {
            isAnalysisEnabled = false;
            toggleAnalysisBtn.classList.remove('active');
            toggleAnalysisBtn.innerText = "üéôÔ∏è PCÈôêÂÆö: „É™„Ç¢„É´„Çø„Ç§„É†Ëß£ÊûêÊºîÂá∫„ÇíON„Å´„Åô„Çã";
            analysisStream = null;
        };

        return true;

    } catch (err) {
        console.error("Error: " + err);
        return false;
    }
}

// „Ç∑„É≥„Éó„É´„Å™„Éì„Éº„ÉàÊ§úÂá∫Ôºà„Ç®„Éç„É´„ÇÆ„ÉºÈñæÂÄ§Ê≥ïÔºâ & Visualizer
function processAudioVisuals() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);

    // Visualizer Draw
    vCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
    const barWidth = visualizerCanvas.width / (dataArray.length / 2);
    
    // ‰ΩéÈü≥Âüü„ÅÆ„Ç®„Éç„É´„ÇÆ„ÉºË®àÁÆó
    let bassEnergy = 0;
    const binCount = 6; 
    for (let i = 0; i < binCount; i++) bassEnergy += dataArray[i];
    bassEnergy /= binCount;

    // Visualizer Bars
    for(let i = 0; i < dataArray.length / 2; i++) {
        const barHeight = dataArray[i];
        // Âº∑„ÅÑ„Éì„Éº„Éà„ÅÆ„Å®„Åç„ÅØËâ≤„ÇíÂ§â„Åà„Çã
        if (bassEnergy > 200) {
            vCtx.fillStyle = `rgba(255, 0, 122, ${barHeight/255})`;
        } else {
            vCtx.fillStyle = `rgba(0, 242, 255, ${barHeight/255})`;
        }
        vCtx.fillRect(i * barWidth, visualizerCanvas.height - barHeight, barWidth, barHeight);
    }

    // Beat Detection Logic for Screen Shake
    energyHistory.push(bassEnergy);
    if (energyHistory.length > 30) energyHistory.shift();
    let avgEnergy = energyHistory.reduce((a,b) => a+b, 0) / energyHistory.length;
    
    const now = performance.now();
    if (bassEnergy > avgEnergy * 1.5 && bassEnergy > 120) {
        if (now - lastNoteTime > 200) { 
            // Âº∑„ÅÑ„Éì„Éº„Éà„ÇíÊ§úÂá∫„Åó„Åü„ÇâÁîªÈù¢„ÇíÊè∫„Çâ„Åô
            triggerBeatEffect();
            lastNoteTime = now;
        }
    }
}

function triggerBeatEffect() {
    gameContainer.classList.remove('shake-effect');
    void gameContainer.offsetWidth; // trigger reflow
    gameContainer.classList.add('shake-effect');
    
    // ËÉåÊôØ„Éï„É©„ÉÉ„Ç∑„É•
    const flash = document.createElement('div');
    flash.style.position = 'absolute';
    flash.style.top = '0'; flash.style.left = '0';
    flash.style.width = '100%'; flash.style.height = '100%';
    flash.style.background = 'rgba(255,255,255,0.1)';
    flash.style.pointerEvents = 'none';
    flash.style.zIndex = '4';
    gameContainer.appendChild(flash);
    setTimeout(() => flash.remove(), 100);
}

// ------ End Audio Analysis ------

function drawArrowNote(lane, x, y, size) {
    const half = size / 2, quarter = size / 4;
    ctx.save(); ctx.translate(x, y);
    ctx.rotate([-Math.PI/2, Math.PI, 0, Math.PI/2][lane]);
    ctx.beginPath();
    ctx.moveTo(0, -half); ctx.lineTo(half, 0); ctx.lineTo(quarter, 0); ctx.lineTo(quarter, half); ctx.lineTo(-quarter, half); ctx.lineTo(-quarter, 0); ctx.lineTo(-half, 0);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
    ctx.beginPath(); ctx.moveTo(0, -half + 4); ctx.lineTo(half - 8, 0); ctx.lineTo(-half + 8, 0); ctx.closePath(); ctx.fill();
    ctx.restore();
}

function checkHit(laneIdx) {
    const now = getCurrentTimeMs();
    let closestNote = null, minDiff = Infinity;
    
    for (let n of notes) {
        if (n.lane === laneIdx && !n.hit) {
            const diff = Math.abs(n.time - now);
            if (diff < minDiff) { minDiff = diff; closestNote = n; }
        }
    }
    if (closestNote && minDiff < JUDGMENT_MS.MISS) {
        let judg = ""; pts = 0;
        if (minDiff < JUDGMENT_MS.PERFECT) { judg = "Perfect"; pts = 1000; stats.perfect++; }
        else if (minDiff < JUDGMENT_MS.GREAT) { judg = "Great"; pts = 700; stats.great++; }
        else if (minDiff < JUDGMENT_MS.GOOD) { judg = "Good"; pts = 400; stats.good++; }
        if (judg) {
            closestNote.hit = true; score += pts; combo++;
            maxCombo = Math.max(combo, maxCombo);
            applyVisualHit(judg, laneIdx);
        }
    }
}

function applyVisualHit(judg, laneIdx) {
    scoreVal.innerText = score.toString().padStart(6, '0');
    judgmentText.innerText = judg;
    const isLight = document.body.classList.contains('light-mode');
    const color = CORE_COLORS[laneIdx % CORE_COLORS.length];
    judgmentText.style.color = color;
    judgmentText.style.textShadow = isLight ? `0 0 10px ${color}` : `0 0 20px ${color}`;
    judgmentText.style.transform = 'scale(1.5)';
    setTimeout(() => judgmentText.style.transform = 'scale(1)', 100);
    if (combo >= 3) { comboText.innerText = combo; comboText.style.opacity = "1"; }
    for (let i = 0; i < 15; i++) {
        particles.push({x: (laneIdx + 0.5) * (canvas.width / LANE_COUNT), y: canvas.height * HIT_LINE_Y, vx: (Math.random() - 0.5) * 18, vy: (Math.random() - 0.5) * 18, life: 1.0, color: CORE_COLORS[laneIdx % CORE_COLORS.length]});
    }
}

function draw() {
    pollGamepad();
    
    // Ëß£Êûê„ÅåÊúâÂäπ„Å™„Çâ„Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„Éº„Å®ÊºîÂá∫„ÇíÂÆüË°å
    if (isAnalysisEnabled) {
        processAudioVisuals();
    }
    
    const now = getCurrentTimeMs();
    
    if (gameState === 'PLAYING' && notes.length > 0 && playMode === 'VIDEO') {
        const firstNoteTime = notes[0].time;
        skipIntroBtn.style.display = (now < firstNoteTime - 4000) ? 'block' : 'none';
    } else {
        skipIntroBtn.style.display = 'none';
    }

    if (gameState !== 'PLAYING') {
        if (gameState === 'START' || gameState === 'FINISHED') requestAnimationFrame(draw);
        return;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const laneWidth = canvas.width / LANE_COUNT, hitY = canvas.height * HIT_LINE_Y, config = DIFFICULTY_CONFIG[currentDiff], isLight = document.body.classList.contains('light-mode');
    
    // Draw Lanes
    for (let i = 0; i < LANE_COUNT; i++) {
        ctx.fillStyle = activeLanes[i] ? (isLight ? 'rgba(0,0,0,0.06)' : 'rgba(255,255,255,0.12)') : 'rgba(128,128,128,0.02)';
        ctx.fillRect(i * laneWidth, 0, laneWidth, canvas.height);
        ctx.strokeStyle = activeLanes[i] ? CORE_COLORS[i] : (isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.15)');
        ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(i * laneWidth + 10, hitY); ctx.lineTo((i + 1) * laneWidth - 10, hitY); ctx.stroke();
    }

    // Draw Notes
    notes.forEach(note => {
        if (note.hit) return;
        
        let timeDiff = note.time - now;
        const speed = config.speed; 
        const y = hitY - (timeDiff * speed);

        if (y > -100 && y < canvas.height + 100) {
            ctx.fillStyle = CORE_COLORS[note.lane]; ctx.shadowBlur = isLight ? 12 : 20; ctx.shadowColor = CORE_COLORS[note.lane];
            drawArrowNote(note.lane, (note.lane + 0.5) * laneWidth, y, laneWidth * 0.7);
            ctx.shadowBlur = 0;
        }
        
        // MissÂà§ÂÆö
        if (timeDiff < -JUDGMENT_MS.MISS && !note.hit) {
            note.hit = true; combo = 0; stats.miss++;
            judgmentText.innerText = "Miss"; comboText.style.opacity = "0";
            judgmentText.style.color = "#666"; judgmentText.style.textShadow = "none";
        }
    });

    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 4 * p.life, 0, Math.PI*2); ctx.fill();
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.025;
    });
    ctx.globalAlpha = 1.0;
    
    if (playMode === 'VIDEO' && ytPlayer?.getPlayerState?.() === YT.PlayerState.ENDED) endGame(); 
    else requestAnimationFrame(draw);
}

async function startGame() {
    const rawName = playerNameInput.value.trim() || (currentLang === 'ja' ? 'ÂêçÁÑ°„Åó' : 'Anonymous');
    localStorage.setItem('neon-hero-player-name-raw', rawName);
    score = 0; combo = 0; maxCombo = 0; stats = { perfect: 0, great: 0, good: 0, miss: 0 };
    particles = []; scoreVal.innerText = "000000"; judgmentText.innerText = "";
    
    if (currentVideoId && ytPlayer) {
        window.registerSharedVideo(currentVideoId, ytPlayer.getVideoData().title, Math.floor(currentDuration), parseInt(bpmInput.value));
        notes = generateMap(currentDuration, currentVideoId);
        playMode = 'VIDEO';
    }

    startScreen.classList.add('hidden'); resultScreen.classList.add('hidden'); gameContainer.classList.add('is-playing');
    
    if (playMode === 'VIDEO' && ytPlayer) {
        if (typeof window.recordPlay === 'function') {
            window.recordPlay(currentVideoId, ytPlayer.getVideoData().title);
        }
        mediaBgContainer.innerHTML = '';
        const playerDiv = ytPlayer.getIframe();
        mediaBgContainer.appendChild(playerDiv);
        ytPlayer.unMute();
        ytPlayer.setVolume(100);
        ytPlayer.seekTo(0);
        ytPlayer.playVideo();
        setTimeout(() => { if (ytPlayer) { ytPlayer.unMute(); ytPlayer.setVolume(100); } }, 500);
    }
    
    gameState = 'PLAYING';
    requestAnimationFrame(draw);
}

// Hybrid Analysis Toggle
toggleAnalysisBtn.addEventListener('click', async () => {
    if (isAnalysisEnabled) {
        // Stop
        if (analysisStream) {
            analysisStream.getTracks().forEach(track => track.stop());
            analysisStream = null;
        }
        isAnalysisEnabled = false;
        toggleAnalysisBtn.classList.remove('active');
        toggleAnalysisBtn.innerText = "üéôÔ∏è PCÈôêÂÆö: „É™„Ç¢„É´„Çø„Ç§„É†Ëß£ÊûêÊºîÂá∫„ÇíON„Å´„Åô„Çã";
    } else {
        // Start
        await setupAudioAnalysis();
    }
});

async function endGame() {
    gameState = 'FINISHED';
    
    // Ëß£Êûê„ÅØÂÅúÊ≠¢„Åõ„Åö„ÄÅÊ¨°Âõû„ÅÆ„Éó„É¨„Ç§„ÅÆ„Åü„ÇÅ„Å´Á∂≠ÊåÅ„Åó„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅ‰∏ÄÂøúÂÅúÊ≠¢„Åô„Çã
    if (isAnalysisEnabled && analysisStream) {
       // Optional: keep it running for seamless retry? 
       // For now, let's keep it running if the user wants to retry immediately.
       // But strictly speaking, we should probably stop it to release resources.
       // Let's stop it for safety.
       analysisStream.getTracks().forEach(track => track.stop());
       analysisStream = null;
       isAnalysisEnabled = false;
       toggleAnalysisBtn.classList.remove('active');
       toggleAnalysisBtn.innerText = "üéôÔ∏è PCÈôêÂÆö: „É™„Ç¢„É´„Çø„Ç§„É†Ëß£ÊûêÊºîÂá∫„ÇíON„Å´„Åô„Çã";
    }
    
    resultScreen.classList.remove('hidden'); gameContainer.classList.remove('is-playing');
    document.getElementById('final-score').innerText = score.toLocaleString();
    document.getElementById('stats-detail').innerHTML = `<span style="color:var(--neon-cyan)">${uiText.stats_perfect}: ${stats.perfect}</span> | <span style="color:var(--neon-pink)">${uiText.stats_great}: ${stats.great}</span> | <span style="color:var(--neon-lime)">${uiText.stats_good}: ${stats.good}</span><br>${uiText.stats_combo}: ${maxCombo} | LEVEL: ${currentDiff.toUpperCase()}`;
    registerScoreBtn.disabled = false;
    if(playMode === 'VIDEO') updateRankingDisplay(currentVideoId, currentDiff, resultRankingList);
}

registerScoreBtn.addEventListener('click', async () => {
    registerScoreBtn.disabled = true;
    const parsed = await parsePlayerName(playerNameInput.value.trim() || "");
    await window.saveGameScore({ playerName: parsed.name, playerTrip: parsed.trip, comment: playerCommentInput.value.trim() || "", score: score, videoId: currentVideoId, difficulty: currentDiff });
    updateRankingDisplay(currentVideoId, currentDiff, resultRankingList);
});

async function updateRankingDisplay(videoId, difficulty, listElement, containerElement = null) {
    if (!videoId) return;
    listElement.innerHTML = '<div class="loader"></div>';
    if (containerElement) containerElement.classList.remove('hidden');
    const topScores = await window.fetchRankings(videoId, difficulty);
    if (topScores.length === 0) { listElement.innerHTML = `<div style="text-align:center; font-size:12px; color:#64748b; padding:10px;">${uiText.msg_no_records}</div>`; return; }
    listElement.innerHTML = topScores.map((item, index) => `<div class="ranking-item"><div class="ranking-header"><span class="ranking-rank">${index + 1}</span><span class="ranking-name">${item.playerName}<span class="ranking-trip">${item.playerTrip || ""}</span></span><span class="ranking-score">${item.score.toLocaleString()}</span></div>${item.comment ? `<div class="ranking-comment">"${item.comment}"</div>` : ""}</div>`).join('');
}

window.addEventListener('keydown', (e) => handleKeyDown(e.key));
window.addEventListener('keyup', (e) => handleKeyUp(e.key));
document.querySelectorAll('.touch-btn').forEach(btn => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleKeyDown(btn.dataset.key); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); handleKeyUp(btn.dataset.key); });
});
startBtn.addEventListener('click', startGame);
retryBtn.addEventListener('click', () => location.reload());

function resize() { 
    canvas.width = gameContainer.clientWidth; 
    canvas.height = gameContainer.clientHeight; 
    visualizerCanvas.width = gameContainer.clientWidth;
    visualizerCanvas.height = 300; // Increase for background effect
}
window.addEventListener('resize', resize); resize();

window.addEventListener('DOMContentLoaded', () => {
    toggleAnalysisBtn.style.display = 'none'; // ÂãïÁîª„É≠„Éº„ÉâÂæå„Å´Ë°®Á§∫

    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÅÆBPMÂæ©ÂÖÉ
    const savedBpm = localStorage.getItem('lastBpm');
    if (savedBpm) bpmInput.value = savedBpm;

    const params = new URLSearchParams(window.location.search);
    const wait = setInterval(() => {
        if (typeof YT !== 'undefined' && YT.Player && typeof window.fetchSharedVideos === 'function') { 
            // URL„Éë„É©„É°„Éº„ÇøÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÁ¢∫Ë™ç
            const vid = params.get('v') || localStorage.getItem('lastVideoId');
            if (vid) { 
                ytUrlInput.value = `https://www.youtube.com/watch?v=${vid}`; 
                loadYoutube(vid); 
            }
            clearInterval(wait); 
        }
    }, 500);
    requestAnimationFrame(draw);
});

if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        this.moveTo(x + r, y); this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r); this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
        this.closePath(); return this;
    }
}
</script>
</body>
</html>
